@{
    ViewData["Title"] = "Categories";
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Categories Management</h2>
        <button type="button" class="btn btn-primary" onclick="showCreateModal()">
            <i class="bi bi-plus-circle"></i> Create New Category
        </button>
    </div>

    <div class="card">
        <div class="card-body">
            <table class="table table-striped" id="categoriesTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="categoriesTableBody">
                    <tr>
                        <td colspan="3" class="text-center">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="categoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Create Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="categoryForm">
                    <input type="hidden" id="categoryId" />
                    <div class="mb-3">
                        <label for="categoryName" class="form-label">Category Name</label>
                        <input type="text" class="form-control" id="categoryName" required />
                        <div class="invalid-feedback" id="nameError"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveCategory()">Save</button>
            </div>
        </div>
    </div>
</div>

@inject IConfiguration Configuration

@section Scripts {
    <script>
        const apiBaseUrl = '@Configuration["ApiBaseUrl"]';
        let categoryModal;

        document.addEventListener('DOMContentLoaded', function () {
            categoryModal = new bootstrap.Modal(document.getElementById('categoryModal'));
            loadCategories();
        });

        function loadCategories() {
            fetch(`${apiBaseUrl}/categories`)
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('categoriesTableBody');
                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="3" class="text-center">No categories found</td></tr>';
                        return;
                    }
                    tbody.innerHTML = data.map(category => `
                        <tr>
                            <td>${category.id}</td>
                            <td>${category.name}</td>
                            <td>
                                <button class="btn btn-sm btn-warning" onclick="editCategory(${category.id})">Edit</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteCategory(${category.id})">Delete</button>
                            </td>
                        </tr>
                    `).join('');
                })
                .catch(error => {
                    console.error('Error loading categories:', error);
                    alert('Failed to load categories');
                });
        }

        function showCreateModal() {
            document.getElementById('modalTitle').textContent = 'Create Category';
            document.getElementById('categoryForm').reset();
            document.getElementById('categoryId').value = '';
            document.getElementById('categoryName').classList.remove('is-invalid');
            categoryModal.show();
        }

        function editCategory(id) {
            fetch(`${apiBaseUrl}/categories/${id}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('modalTitle').textContent = 'Edit Category';
                    document.getElementById('categoryId').value = data.id;
                    document.getElementById('categoryName').value = data.name;
                    document.getElementById('categoryName').classList.remove('is-invalid');
                    categoryModal.show();
                })
                .catch(error => {
                    console.error('Error loading category:', error);
                    alert('Failed to load category details');
                });
        }

        function saveCategory() {
            const id = document.getElementById('categoryId').value;
            const name = document.getElementById('categoryName').value.trim();
            const nameInput = document.getElementById('categoryName');
            const nameError = document.getElementById('nameError');

            if (!name) {
                nameInput.classList.add('is-invalid');
                nameError.textContent = 'Category name is required';
                return;
            }

            nameInput.classList.remove('is-invalid');

            const isEdit = id !== '';
            const url = isEdit ? `${apiBaseUrl}/categories/${id}` : `${apiBaseUrl}/categories`;
            const method = isEdit ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name: name })
            })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(text || 'Failed to save category');
                        });
                    }
                    categoryModal.hide();
                    loadCategories();
                    alert(isEdit ? 'Category updated successfully' : 'Category created successfully');
                })
                .catch(error => {
                    console.error('Error saving category:', error);
                    nameInput.classList.add('is-invalid');
                    nameError.textContent = error.message;
                });
        }

        function deleteCategory(id) {
            if (!confirm('Are you sure you want to delete this category?')) {
                return;
            }

            fetch(`${apiBaseUrl}/categories/${id}`, {
                method: 'DELETE'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to delete category');
                    }
                    loadCategories();
                    alert('Category deleted successfully');
                })
                .catch(error => {
                    console.error('Error deleting category:', error);
                    alert('Failed to delete category');
                });
        }
    </script>
}
