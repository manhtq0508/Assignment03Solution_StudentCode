@inject IConfiguration Configuration
@inject Microsoft.AspNetCore.Identity.UserManager<Microsoft.AspNetCore.Identity.IdentityUser> UserManager

@{
    ViewData["Title"] = "Create Order";
    var user = await UserManager.GetUserAsync(User);
    var userId = user?.Id;
}

<div class="container mt-4">
    <div class="card">
        <div class="card-header">
            <h3>Create New Order</h3>
        </div>
        <div class="card-body">
            <form id="orderForm">
                <div class="mb-3">
                    <label for="freight" class="form-label">Freight</label>
                    <input type="number" step="0.01" class="form-control" id="freight" value="0" required />
                    <div class="invalid-feedback" id="freightError"></div>
                </div>

                <h5 class="mt-4">Order Details</h5>
                <div class="mb-3">
                    <button type="button" class="btn btn-sm btn-success" onclick="showAddProductModal()">Add Product</button>
                </div>

                <table class="table table-bordered" id="orderDetailsTable">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Unit Price</th>
                            <th>Quantity</th>
                            <th>Discount</th>
                            <th>Subtotal</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="orderDetailsBody">
                        <tr>
                            <td colspan="6" class="text-center">No products added</td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <th colspan="4" class="text-end">Total:</th>
                            <th id="totalAmount">$0.00</th>
                            <th></th>
                        </tr>
                    </tfoot>
                </table>

                <div class="mt-3">
                    <button type="button" class="btn btn-primary" onclick="submitOrder()">Create Order</button>
                    <a asp-action="Index" class="btn btn-secondary">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Product to Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addProductForm">
                    <div class="mb-3">
                        <label for="productSelect" class="form-label">Product</label>
                        <select class="form-select" id="productSelect" required>
                            <option value="">Select Product...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="unitPrice" class="form-label">Unit Price</label>
                        <input type="number" step="0.01" class="form-control" id="unitPrice" readonly />
                    </div>
                    <div class="mb-3">
                        <label for="quantity" class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="quantity" min="1" value="1" required />
                        <small class="text-muted">Available: <span id="availableStock">0</span></small>
                        <div class="invalid-feedback" id="quantityError"></div>
                    </div>
                    <div class="mb-3">
                        <label for="discount" class="form-label">Discount</label>
                        <input type="number" step="0.01" class="form-control" id="discount" min="0" max="1" value="0" required />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addProductToOrder()">Add</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const apiBaseUrl = '@Configuration["ApiBaseUrl"]';
        const userId = '@userId';
        let products = [];
        let orderDetails = [];
        let addProductModal;

        document.addEventListener('DOMContentLoaded', function () {
            addProductModal = new bootstrap.Modal(document.getElementById('addProductModal'));
            loadProducts();

            document.getElementById('productSelect').addEventListener('change', function() {
                const productId = parseInt(this.value);
                const product = products.find(p => p.id === productId);
                if (product) {
                    document.getElementById('unitPrice').value = product.unitPrice.toFixed(2);
                    document.getElementById('availableStock').textContent = product.unitsInStock;
                    document.getElementById('quantity').max = product.unitsInStock;
                }
            });
        });

        function loadProducts() {
            fetch(`${apiBaseUrl}/products`)
                .then(response => response.json())
                .then(data => {
                    products = data;
                    const select = document.getElementById('productSelect');
                    select.innerHTML = '<option value="">Select Product...</option>' +
                        data.map(p => `<option value="${p.id}">${p.name} (Stock: ${p.unitsInStock})</option>`).join('');
                })
                .catch(error => {
                    console.error('Error loading products:', error);
                    alert('Failed to load products');
                });
        }

        function showAddProductModal() {
            document.getElementById('addProductForm').reset();
            document.getElementById('quantity').classList.remove('is-invalid');
            addProductModal.show();
        }

        function addProductToOrder() {
            const productId = parseInt(document.getElementById('productSelect').value);
            const unitPrice = parseFloat(document.getElementById('unitPrice').value);
            const quantity = parseInt(document.getElementById('quantity').value);
            const discount = parseFloat(document.getElementById('discount').value);

            if (!productId) {
                alert('Please select a product');
                return;
            }

            const product = products.find(p => p.id === productId);
            if (!product) {
                alert('Product not found');
                return;
            }

            if (orderDetails.find(od => od.productId === productId)) {
                alert('This product is already added to the order');
                return;
            }

            if (quantity > product.unitsInStock) {
                document.getElementById('quantity').classList.add('is-invalid');
                document.getElementById('quantityError').textContent = `Quantity exceeds available stock (${product.unitsInStock})`;
                return;
            }

            if (isNaN(discount) || discount < 0 || discount > 1) {
                alert('Discount must be between 0 and 1');
                return;
            }

            orderDetails.push({
                productId: productId,
                productName: product.name,
                unitPrice: unitPrice,
                quantity: quantity,
                discount: discount
            });

            renderOrderDetails();
            addProductModal.hide();
        }

        function removeProduct(productId) {
            orderDetails = orderDetails.filter(od => od.productId !== productId);
            renderOrderDetails();
        }

        function renderOrderDetails() {
            const tbody = document.getElementById('orderDetailsBody');
            if (orderDetails.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">No products added</td></tr>';
                document.getElementById('totalAmount').textContent = '$0.00';
                return;
            }

            let total = 0;
            tbody.innerHTML = orderDetails.map(od => {
                const subtotal = od.unitPrice * od.quantity * (1 - od.discount);
                total += subtotal;
                return `
                    <tr>
                        <td>${od.productName}</td>
                        <td>$${od.unitPrice.toFixed(2)}</td>
                        <td>${od.quantity}</td>
                        <td>${(od.discount * 100).toFixed(0)}%</td>
                        <td>$${subtotal.toFixed(2)}</td>
                        <td><button class="btn btn-sm btn-danger" onclick="removeProduct(${od.productId})">Remove</button></td>
                    </tr>
                `;
            }).join('');

            document.getElementById('totalAmount').textContent = `$${total.toFixed(2)}`;
        }

        function submitOrder() {
            const freight = parseFloat(document.getElementById('freight').value);

            if (isNaN(freight) || freight < 0) {
                document.getElementById('freight').classList.add('is-invalid');
                document.getElementById('freightError').textContent = 'Freight must be a non-negative value';
                return;
            }

            if (orderDetails.length === 0) {
                alert('Please add at least one product to the order');
                return;
            }

            const orderData = {
                memberId: userId,
                freight: freight,
                orderDetails: orderDetails.map(od => ({
                    productId: od.productId,
                    unitPrice: od.unitPrice,
                    quantity: od.quantity,
                    discount: od.discount
                }))
            };

            fetch(`${apiBaseUrl}/orders`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(orderData)
            })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(text || 'Failed to create order');
                        });
                    }
                    alert('Order created successfully');
                    window.location.href = '/Order/Index';
                })
                .catch(error => {
                    console.error('Error creating order:', error);
                    alert(error.message);
                });
        }
    </script>
}
